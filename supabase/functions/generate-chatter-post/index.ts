import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import OpenAI from 'https://deno.land/x/openai@v4.52.7/mod.ts';
import { corsHeaders } from '../_shared/cors.ts';

const prompts = {
    beauty: {
        system: `ì œê³µëœ ë°ì´í„° ê¸€ì“´ì´ì˜ ë¬¸ì²´, ì–´ì¡°, ë‹¨ì–´ ì„ íƒ, ë¬¸ì¥ êµ¬ì¡°, ë‰´ë¼ì¸ ê°¯ìˆ˜, ìì£¼ ì‚¬ìš©í•˜ëŠ” í‘œí˜„ê³¼ ë‹¨ì–´, ë¶ˆê·œì¹™í•œ ì¤„ë°”ê¿ˆ(ë‰´ë¼ì¸) ë“±ì„ ë¶„ì„í•˜ì—¬ ëª¨ë°©í•´ì•¼í•´. 

[ì‘ì„±í•´ì•¼í•  ë‚´ìš©]
ì‘ì„±ì ì´ë¦„ 1ê°œ: í•œê¸€ ë˜ëŠ” ì˜ì–´ë¡œ ëœ ê°œì„±ìˆëŠ” ì‘ì„±ì ì´ë¦„ì„ ìƒì„±í•œë‹¤.
ì œëª© 1ê°œ: ì œê³µëœ ë°ì´í„°ì˜ ê¸€ì“´ì´ ì œëª©ì„ ëª¨ë°©í•˜ì—¬ ë·°í‹° ì£¼ì œë¡œ ë³€ê²½í•´ì„œ ë‚´ìš©ì„ ì‘ì„±í•œë‹¤.
ë³¸ë¬¸ 1ê°œ: ì œê³µëœ ë°ì´í„°ì˜ ê¸€ì“´ì´ ë³¸ë¬¸ì„ ëª¨ë°©í•˜ì—¬ ë·°í‹° ì£¼ì œë¡œ ë³€ê²½í•´ì„œ ë‚´ìš©ì„ ì‘ì„±í•œë‹¤. ì›ë˜ ë³¸ë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ ìƒˆë¡­ê²Œ ì‘ì„±ë  ë³¸ë¬¸ì€ ê¸°ì¡´ ë³¸ë¬¸ì˜ ê¸¸ì´ ë§Œí¼ ì •í™•íˆ ì‘ì„±ë˜ë©°, ì˜ˆë¥¼ë“¤ì–´ ê¸ˆì•¡, ìˆ«ìê°€ ë‚˜ì˜¤ë©´ ë³¸ë¬¸ê³¼ ë‹¤ë¥´ê²Œ ë³€ê²½í•˜ì§€ë§Œ ë°˜ë“œì‹œ í˜„ì‹¤ì ì¸ ìˆ«ìì—¬ì•¼í•˜ëŠ”ì  ì£¼ì˜í•´. ê·¸ë¦¬ê³  ìƒˆë¡œ ì ëŠ” ì£¼ì œì™€ ê¸°ì¡´ ë‚´ìš©ì´ ë¬¸ë§¥ì´ ë§ê³  í˜„ì‹¤ì„±ì´ ìˆì–´ì•¼í•´.
ëŒ“ê¸€ì€ ì ˆëŒ€ë¡œ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤. 

[ì „ì²´ ìš”êµ¬ì‚¬í•­]
- ìƒì„±í•œ ë³¸ë¬¸ ì•ˆì— ã… ã… , ã…ã…,ã…œ,ã…  ì´ëŸ° ë¬¸ì¥ ëª¨ì–‘, ë˜ëŠ” ^^ ë“¤ì–´ê°€ì•¼í•œë‹¤. í•˜ì§€ë§Œ ã… ã… , ã…œã…œ ì´ê±°ëŠ” ë°˜ë“œì‹œ 2ê¸€ì§€ ì´ìƒ ì‘ì„±ë˜ë©´ ì•ˆë˜
- íŠ¹ìˆ˜ë¬¸ìëŠ” ì‹¤ì œ ì‚¬ëŒì´ ì“°ì§€ ì•Šìœ¼ë‹ˆ ì ˆëŒ€ë¡œ ì“°ë©´ ì•ˆëœë‹¤.
- ìƒì„±í•œ ë³¸ë¬¸ ì•ˆì— "í–ˆëŠ”ë°........" ì´ëŸ°ì‹ "ì•„....." ì´ëŸ¬ì‹ "ì§„ì§œ;;;" ë‚˜ "ì–´ë–»ê²Œ,,," ë“±ë“± ì´ëŸ° ì¢…ë¥˜ì˜ ì¹œê·¼í•œ í‘œí˜„ì„ ìì£¼ ì‚¬ìš©í•´
- ìƒì„±í•œ ë³¸ë¬¸ ì•ˆì— ëª¨ë‘ êµ¬ì–´ì²´ë¡œ ì¹œí•œ ì¹œêµ¬ì—ê²Œ ë§í•˜ëŠ” ê²ƒì²˜ëŸ¼ "ì•„ë‹ˆêµ¬......" "ê°™ì•„ì—¬....." "í–ˆì—ˆêµ¬....." ê°™ì€ í‘œí˜„ì„ ìì£¼ ì‚¬ìš©í•´
- ìƒì„±í•œ ë³¸ë¬¸ ì•ˆì— ì´ëª¨ì§€ê°€ ë“¤ì–´ê°€ì•¼í•œë‹¤. ì‚¬ìš©ê°€ëŠ¥í•œ ì´ëª¨ì§€ëŠ” ğŸ™‡ğŸ»â€â™€ï¸â¤ï¸â£ï¸ğŸ˜ğŸ«¢ğŸ‘ğŸ»ğŸ¥¹ğŸ¥°, í•˜ì§€ë§Œ ë¬¸ë§¥ì— ë§ê²Œ ì´ëª¨ì§€ë¥¼ ëª¨ì–‘ì¼ ì„ íƒí•´ ì‚¬ìš©í•´ì•¼í•œë‹¤.
- ìƒì„±í•œ ë³¸ë¬¸ ì•ˆì— \\nì„ 1ë²ˆ ì‚¬ìš© ë˜ëŠ” \\n\\n 2ë²ˆ ì—°ì† ì‚½ì…í•´ì„œ ì‚¬ëŒì²˜ëŸ¼ ë³´ì—¬ì•¼í•œë‹¤. ë¬¸ì¥ì´ ëë‚ ë•Œ ë§ˆë‹¤\në¥¼ ë„£ì–´ì„œ ê°€ë…ì„±ì„ ë†’ì—¬ì•¼í•´
- í•œêµ­ì–´ë‚˜ ì˜ì–´ ë‹¨ì–´ë§Œ ë“¤ì–´ê°€ì•¼í•´. ë‹¨ì–´ ì¤‘ê°„ì— í•œêµ­ì–´ê°€ ì•„ë‹Œ ì™¸êµ­ì–´ ë¬¸ìì—´ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë° ëª¨ë‘ í•œê¸€ë¡œ ë³€ê²½í•´ì•¼í•œë‹¤. 
- íŠ¹ì • ì œí’ˆëª… ë§í•˜ì§€ë§ˆ
- ê°ê° ëŒ“ê¸€ì— êµ¬ì–´ì²´ ì‚¬ìš©í•´
- jsonìœ¼ë¡œ ì‘ë‹µí•´ í¬ë§·ì€ ë‹¤ìŒê³¼ ê°™ì•„ {author: "ìƒì„±ëœ ì‘ì„±ì ì´ë¦„", title: "ìƒì„±ëœ ì œëª©", content: "ìƒì„±ëœ ë³¸ë¬¸", count: "ëœë¤ìœ¼ë¡œ ì¡°íšŒìˆ˜"}`,
    },
    certificateReview: {
        system: `ì œê³µëœ 'ìê²©ì¦ í•©ê²© í›„ê¸°' ë°ì´í„°ì˜ ê¸€ì“´ì´ ìŠ¤íƒ€ì¼(ë¬¸ì²´, ì–´ì¡°, ì¤„ë°”ê¿ˆ, í‘œí˜„)ì„ ì™„ë²½í•˜ê²Œ ëª¨ë°©í•´ì„œ, ì™„ì „íˆ ìƒˆë¡œìš´ 'ìê²©ì¦ í•©ê²© í›„ê¸°' ê²Œì‹œê¸€ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

[ì‘ì„±í•´ì•¼í•  ë‚´ìš©]
ë°˜ë“œì‹œ ë·°í‹° ê´€ë ¨ ìê²©ì¦ì— ëŒ€í•œ í›„ê¸° ì—¬ì•¼í•´
ì‘ì„±ì ì´ë¦„ 1ê°œ: í•©ê²© í›„ê¸°ë¥¼ ì“¸ ë²•í•œ ì§„ì†”í•œ ëŠë‚Œì˜ ë‹‰ë„¤ì„ì„ ìƒì„±í•©ë‹ˆë‹¤.
ì œëª© 1ê°œ: ì›ë³¸ ì œëª© ìŠ¤íƒ€ì¼ì„ ëª¨ë°©í•˜ì—¬, ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ìê²©ì¦ í•©ê²© í›„ê¸° ì œëª©ì„ ë§Œë“­ë‹ˆë‹¤. (ì˜ˆ: ì •ë³´ì²˜ë¦¬ê¸°ì‚¬, ì»´í“¨í„°í™œìš©ëŠ¥ë ¥)
ë³¸ë¬¸ 1ê°œ: ì›ë³¸ ë³¸ë¬¸ì˜ ìŠ¤íƒ€ì¼ê³¼ ê¸¸ì´ë¥¼ ë”°ë¼, ìƒˆë¡œìš´ ìê²©ì¦ ì‹œí—˜ì„ ì¤€ë¹„í•˜ê³  í•©ê²©í•œ ê³¼ì •ì„ ìƒì„¸í•˜ê³  í˜„ì‹¤ê° ìˆê²Œ ì‘ì„±í•©ë‹ˆë‹¤. ê³µë¶€ ë°©ë²•, ì–´ë ¤ì› ë˜ ì , í•©ê²© íŒ ë“±ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ì›ë³¸ì˜ ìˆ«ì(ê¸°ê°„, ì ìˆ˜ ë“±)ê°€ ë‚˜ì˜¤ë©´, í˜„ì‹¤ì ì¸ ë‹¤ë¥¸ ìˆ«ìë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
ëŒ“ê¸€ì€ ì ˆëŒ€ë¡œ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.

[ì „ì²´ ìš”êµ¬ì‚¬í•­]
- ê¸€ì˜ ì „ì²´ì ì¸ êµ¬ì¡°ì™€ ë¬¸ë‹¨ ë‚˜ëˆ„ê¸°, ì¤„ë°”ê¿ˆ(\n ë˜ëŠ” \n\n) ìŠ¤íƒ€ì¼ì„ ì›ë³¸ê³¼ ë§¤ìš° ìœ ì‚¬í•˜ê²Œ ë”°ë¼í•´ì•¼ í•©ë‹ˆë‹¤.
- ì›ë³¸ì²˜ëŸ¼ ã…ã…, ã… ã… , ^^ ê°™ì€ í‘œí˜„ì´ë‚˜ ì´ëª¨ì§€(ğŸ‰, ğŸ‘, ğŸ™, ğŸ˜‚)ê°€ ìˆë‹¤ë©´ ì ì ˆí•˜ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- "~~í–ˆê³ ìš”...", "~~í–ˆë˜ ê²ƒ ê°™ì•„ìš”.", "ì§„ì§œ í˜ë“¤ì—ˆëŠ”ë°..." ì™€ ê°™ì´ êµ¬ì–´ì²´ ì¤‘ì‹¬ì˜ ì§„ì†”í•œ ì–´ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ë¬¸ë§¥ì— ë§ëŠ” ì „ë¬¸ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹ ë¢°ë„ë¥¼ ë†’ì—¬ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: '2ê³¼ëª© í•„ê¸° ì ìˆ˜ê°€ ì•ˆë‚˜ì™€ì„œ í˜ë“¤ì—ˆì–´ìš”', 'ì‹¤ê¸°ëŠ” ê¸°ì¶œë¬¸ì œë¥¼ ê³„ì† ëŒë ¸ìŠµë‹ˆë‹¤')
- jsonìœ¼ë¡œ ì‘ë‹µí•´ì•¼ í•˜ë©°, í¬ë§·ì€ {author: "ìƒì„±ëœ ì‘ì„±ì ì´ë¦„", title: "ìƒì„±ëœ ì œëª©", content: "ìƒì„±ëœ ë³¸ë¬¸", count: "ëœë¤ìœ¼ë¡œ ì¡°íšŒìˆ˜"} ì…ë‹ˆë‹¤.`,
    }
};

serve(async (req) => {
    if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders });
    }

    try {
        const { topic } = await req.json();
        if (!topic || !prompts[topic]) {
            throw new Error(`'${topic}'ì€(ëŠ”) ìœ íš¨í•œ ì£¼ì œê°€ ì•„ë‹™ë‹ˆë‹¤.`);
        }

        const tableIdentifier = topic === 'beauty' ? 'articles' : 'certificate_reviews';
        const selectedPrompt = prompts[topic].system;

        const supabaseAdmin = createClient(
            Deno.env.get('SUPABASE_URL') ?? '',
            Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
        );

        const { data: record, error: rpcError } = await supabaseAdmin.rpc('get_next_record', {
            p_table_identifier: tableIdentifier
        });

        if (rpcError) throw rpcError;
        if (!record || record.length === 0) {
            return new Response(JSON.stringify({ message: 'ë” ì´ìƒ ì²˜ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' }), {
                headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 404
            });
        }

        const sourceRecord = record[0];
        const openai = new OpenAI({ apiKey: Deno.env.get('OPENAI_API_KEY') });
        const userPrompt = `[ì œëª©] \n${sourceRecord.title || ''}\n[ë³¸ë¬¸]\n${sourceRecord.content || ''}`;

        const response = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: [{ role: "system", content: selectedPrompt }, { role: "user", content: userPrompt }],
            temperature: 1.3,
            top_p: 0.3,
        });

        const gptContent = response.choices[0].message.content || "";
        const jsonMatch = gptContent.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error("AI ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSON ê°ì²´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

        const parsedFromAI = JSON.parse(jsonMatch[0]);
        const generatedArticle = {
            author: "AI_Bot",
            title: "ì œëª© ìƒì„± ì‹¤íŒ¨",
            content: "ë³¸ë¬¸ ìƒì„± ì‹¤íŒ¨",
            count: 0,
            ...parsedFromAI
        };

        const finalResponse = {
            sourceArticleId: sourceRecord.id,
            sourceTable: tableIdentifier,
            generatedArticle: generatedArticle,
        };

        return new Response(JSON.stringify(finalResponse), {
            headers: { ...corsHeaders, 'Content-Type': 'application/json' },
            status: 200,
        });

    } catch (error) {
        console.error("## generate-chatter-post í•¨ìˆ˜ ì˜¤ë¥˜:", error);
        return new Response(JSON.stringify({ message: error.message }), {
            headers: { ...corsHeaders, 'Content-Type': 'application/json' },
            status: 500,
        });
    }
});